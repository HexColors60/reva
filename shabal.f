
| Generate "SHA1" checksum for a list of files
| vim: ft=reva :
needs asm/x86
create shabal-iv
	| output size = 32 bits
	$30991624 , $806813D1 , $BCA662CB , $D12B9E3E ,
	$015C94E0 , $90864C9D , $8EE87628 , $C9B16670 ,
	$6300436B , $00B74372 , $6410F22C , $727CCCA8 ,
	$405762CA , $ADAFA2DD , $094A20D4 , $0299DB0E ,
	$8E697024 , $80301429 , $9FD43B12 , $43429851 ,
	$B6CE9CE7 , $FD7E01E8 , $05C08832 , $1B0B9BF9 ,
	$203139BE , $DF941A78 , $9028DC03 , $D5079E88 ,
	$DC16B134 , $1D902C0F , $7FABDE1C , $3BD00C56 ,
	$2C6130DA , $DDACF5F4 , $5FC89982 , $9992F1D5 ,
	$A26EC215 , $82DFFD2C , $CA1F5AC1 , $3005D535 ,
	$4F845186 , $624E8186 , $7E8EAA93 , $0CC5813E ,

	| output size = 64 bits
	$AFBA1D74 , $43D93628 , $ED6741E5 , $24E6B5AD ,
	$7CF8195B , $1348594B , $0B1D67BB , $8ECE0945 ,
	$27A57DFA , $A3C28A8C , $88108C3E , $4E48C0AF ,
	$C581116E , $16ED2D7F , $F5A2D28F , $C56D559D ,
	$BAA08E92 , $64D7C8FC , $3E690AC9 , $38B69953 ,
	$04DCCD05 , $D1C9359A , $6A8545FA , $515BB34E ,
	$81FAC868 , $EB40C1E5 , $6D95629C , $45C0F632 ,
	$02105ED2 , $BCA69AFF , $7402E45C , $3B3AE370 ,
	$08A04FA4 , $5A6CD21D , $462EB4C0 , $8CC6966C ,
	$500569B9 , $5B580756 , $8A23BEA0 , $0C0D95F0 ,
	$A8A2CC5E , $9DF90247 , $E33F5B0F , $4CA34C8E ,

	| output size = 96 bits
	$9D63B7AE , $30D32AD2 , $FD2D64F8 , $1A4F88ED  ,
	$9F8C1E0E , $5B40AC3A , $BC49378A , $78C4CEB7  ,
	$4D460412 , $368F606F , $203C7132 , $07775329  ,
	$2A7DD153 , $9E434DA3 , $6986024A , $160620C6  ,
	$6A0DDA63 , $0C300A9D , $928D0C82 , $A2AEA46C  ,
	$5B026685 , $9D381B86 , $852DF223 , $336AFB47  ,
	$FCE8B147 , $F7D77805 , $24FD4088 , $DCA077F4  ,
	$48B9AF9E , $ABDF6C90 , $0DCD5ED5 , $EECB6206  ,
	$6D12A365 , $98F87C66 , $CDC87E8D , $B5B4A748  ,
	$704AC162 , $9F1CBD4B , $E61902FF , $B1BB72EA  ,
	$2970E70A , $CEF5B6A6 , $14DF55CB , $20943F97  ,
  
	| output size = 128 bits  
	$78B31FB9 , $B6752098 , $7E0A5E4F , $B9909576  ,
	$D29FEA11 , $5001C1B0 , $173061EB , $6259160F  ,
	$BA854A36 , $6B335E13 , $B6DBCF5C , $1D2D8037  ,
	$1DFBAFBB , $DAA1D17F , $11432D8F , $22FE6988  ,
	$438A5BB8 , $017AA3EA , $DC20F53C , $A32C1D59  ,
	$F4EB3A99 , $9F6B309D , $475AF4D1 , $04AE709E  ,
	$6FE7FEB6 , $88F92195 , $80DD47EF , $EC247FDE  ,
	$D1E7C920 , $AE103B8D , $98C6AD6B , $66B44C42  ,
	$26ACADFF , $17CE770A , $EC52610A , $8EA29C91  ,
	$9ADA9EB5 , $68EAB2A2 , $0D7CFF0C , $F34510D5  ,
	$0CA1C747 , $AFF5CB59 , $EDBD3DC8 , $35E3FEBA  ,
  
	| output size = 160 bits  
	$23043D95 , $ADF7E880 , $F5A289A7 , $08CE1221  ,
	$D8033158 , $655D4342 , $F8F100BC , $AEB91981  ,
	$2A2F6A37 , $AF532EE8 , $3637E85F , $26FF1DB0  ,
	$9C04E33B , $001EA45F , $BFF4AD80 , $BE0EFADB  ,
	$3F4E1699 , $4AC015FF , $CE944991 , $657C86A4  ,
	$16237082 , $69E66332 , $081B6170 , $616FBCEF  ,
	$AA62AB9A , $D722D78F , $74CA0624 , $A6CA8341  ,
	$9FFD9230 , $29A59196 , $533E5573 , $D4DF9963  ,
	$6171440E , $0ECC85CF , $CB2B959C , $89654A9F  ,
	$4CA1C101 , $B55C326C , $F6D7614C , $380EED0C  ,
	$51AC69B0 , $6199E925 , $CAAB12F6 , $1B3AB589  ,
  
	| output size = 192 bits  
	$FD749ED4 , $B798E530 , $33904B6F , $46BDA85E  ,
	$076934B4 , $454B4058 , $77F74527 , $FB4CF465  ,
	$62931DA9 , $E778C8DB , $22B3998E , $AC15CFB9  ,
	$58BCBAC4 , $EC47A08E , $AEE933B2 , $DFCBC824  ,
	$A7944804 , $BF65BDB0 , $5A9D4502 , $59979AF7  ,
	$C5CEA54E , $4B6B8150 , $16E71909 , $7D632319  ,
	$930573A0 , $F34C63D1 , $CAF914B4 , $FDD6612C  ,
	$61550878 , $89EF2B75 , $A1660C46 , $7EF3855B  ,
	$7297B58C , $1BC67793 , $7FB1C723 , $B66FC640  ,
	$1A48B71C , $F0976D17 , $088CE80A , $A454EDF3  ,
	$1C096BF4 , $AC76224B , $5215781C , $CD5D2669  ,
  
	| output size = 224 bits  
	$A5201467 , $A9B8D94A , $D4CED997 , $68379D7B  ,
	$A7FC73BA , $F1A2546B , $606782BF , $E0BCFD0F  ,
	$2F25374E , $069A149F , $5E2DFF25 , $FAECF061  ,
	$EC9905D8 , $F21850CF , $C0A746C8 , $21DAD498  ,
	$35156EEB , $088C97F2 , $26303E40 , $8A2D4FB5  ,
	$FEEE44B6 , $8A1E9573 , $7B81111A , $CBC139F0  ,
	$A3513861 , $1D2C362E , $918C580E , $B58E1B9C  ,
	$E4B573A1 , $4C1A0880 , $1E907C51 , $04807EFD  ,
	$3AD8CDE5 , $16B21302 , $02512C53 , $2204CB18  ,
	$99405F2D , $E5B648A1 , $70AB1D43 , $A10C25C2  ,
	$16F1AC05 , $38BBEB56 , $9B01DC60 , $B1096D83  ,
  
	| output size = 256 bits  
	$52F84552 , $E54B7999 , $2D8EE3EC , $B9645191  ,
	$E0078B86 , $BB7C44C9 , $D2B5C1CA , $B0D2EB8C  ,
	$14CE5A45 , $22AF50DC , $EFFDBC6B , $EB21B74A  ,
	$B555C6EE , $3E710596 , $A72A652F , $9301515F  ,
	$DA28C1FA , $696FD868 , $9CB6BF72 , $0AFE4002  ,
	$A6E03615 , $5138C1D4 , $BE216306 , $B38B8890  ,
	$3EA8B96B , $3299ACE4 , $30924DD4 , $55CB34A5  ,
	$B405F031 , $C4233EBA , $B3733979 , $C0DD9D55  ,
	$C51C28AE , $A327B8E1 , $56C56167 , $ED614433  ,
	$88B59D60 , $60E2CEBA , $758B4B8B , $83E82A7F  ,
	$BC968828 , $E6E00BF7 , $BA839E55 , $9B491C60  ,
  
	| output size = 288 bits  
	$66653F11 , $F9446EDB , $3E8568FB , $E519F95A  ,
	$D6732054 , $B2BDA0C5 , $492F3CF8 , $8FD63B96  ,
	$B4EF4648 , $7E5488E5 , $A7ED170A , $5B25FA52  ,
	$BBC636A1 , $B87FB1E3 , $ED8EED32 , $6D10E8D5  ,
	$34868338 , $56EB9A07 , $27C8D6ED , $0283EF48  ,
	$6B1AB349 , $2619870B , $DDD0A56C , $7F72935B  ,
	$D2B1A3C6 , $D7DA5563 , $58292E94 , $363320A4  ,
	$B8904378 , $BC37135F , $2FCFECEC , $C74DF052  ,
	$B70F01DE , $523EB809 , $D8E14A78 , $181A659D  ,
	$90894E40 , $48865BA0 , $282C1F3F , $1C2488E9  ,
	$0141B2E6 , $FFD06EFB , $A1F15A68 , $CFB06A87  ,
  
	| output size = 320 bits  
	$15FB76C8 , $8BA3597D , $1B66A087 , $65C5555B  ,
	$3962E239 , $4EA9C7C7 , $93D9671B , $3074B7BE  ,
	$A224ED96 , $38A8A88B , $9A515FEA , $125ADBD4  ,
	$F30E67D1 , $CD0679E4 , $0F373D5F , $1FCEF74D  ,
	$5C80F3FB , $A6C70631 , $0ECD6A69 , $73885C8F  ,
	$1B77FE69 , $D487D25A , $C027EED1 , $3F31BD8F  ,
	$E275F714 , $92D07441 , $5B70FF10 , $177AE160  ,
	$6FCFA5FB , $67139322 , $2D3109B2 , $601A088C  ,
	$293386A7 , $F87584AB , $00862B83 , $87EF6304  ,
	$F69DA436 , $6AA88022 , $09D1EC75 , $8099B045  ,
	$59F8B2DE , $343456A8 , $91F66DAE , $AF1D30ED  ,
  
	| output size = 352 bits  
	$1BD5653A , $63D79468 , $AE5166FA , $3FA0E9CC  ,
	$3578296E , $FFAA2881 , $A07E89ED , $F38890CA  ,
	$09111A9E , $F908F100 , $8476444D , $FE33E1F8  ,
	$5B228C89 , $1982F710 , $0C51EE3E , $CC6C68EE  ,
	$5629BF34 , $CDEA4F9F , $203C3ECA , $E352E40A  ,
	$3FC6F380 , $35E1DA2D , $8522A9DB , $B1DB66AE  ,
	$07C002A7 , $E495CA9B , $8D8B1D89 , $1848DDFC  ,
	$2B5E7D26 , $1F25F07D , $9B9E6378 , $8DC9DDA7  ,
	$44221A9D , $193A59CB , $BB7ACA55 , $432325AB  ,
	$15CE4B4E , $6ED2B4DE , $42261A9F , $8DCADC14  ,
	$EB49BC8E , $F566AEC0 , $8A56D431 , $216B0327  ,
  
	| output size = 384 bits  
	$C8FCA331 , $E55C504E , $003EBF26 , $BB6B8D83  ,
	$7B0448C1 , $41B82789 , $0A7C9601 , $8D659CFF  ,
	$B6E2673E , $CA54C77B , $1460FD7E , $3FCB8F2D  ,
	$527291FC , $2A16455F , $78E627E5 , $944F169F  ,
	$1CA6F016 , $A854EA25 , $8DB98ABE , $F2C62641  ,
	$30117DCB , $CF5C4309 , $93711A25 , $F9F671B8  ,
	$B01D2116 , $333F4B89 , $B285D165 , $86829B36  ,
	$F764B11A , $76172146 , $CEF6934D , $C6D28399  ,
	$FE095F61 , $5E6018B4 , $5048ECF5 , $51353261  ,
	$6E6E36DC , $63130DAD , $A9C69BD6 , $1E90EA0C  ,
	$7C35073B , $28D95E6D , $AA340E0D , $CB3DEE70  ,
  
	| output size = 416 bits  
	$352E0FF3 , $6AC9C045 , $2DB4EF9C , $77FA2ABD  ,
	$338FDD70 , $50534EFF , $FC4AEAD6 , $7FD5E90F  ,
	$D427A064 , $AEEFEA00 , $B2FE4468 , $E0865D75  ,
	$FBA3A3EF , $426D3426 , $C3B9AD71 , $75BB8771  ,
	$641F7D90 , $A4D1C61E , $50B1078C , $DFD10A17  ,
	$CBF00300 , $84931E03 , $B3785FBB , $B2FE8C72  ,
	$FBD8FFE0 , $668069B2 , $9389E26C , $A48A5538  ,
	$F4FEB4AD , $53794AD4 , $C7646768 , $95CA7E26  ,
	$4826175D , $FA1862B5 , $3D4FD63C , $18D1D0B3  ,
	$460F51F6 , $B6B0FD70 , $EB95B530 , $36B38BC3  ,
	$712EC1DD , $F1358202 , $1C4B7E51 , $F3B66BD6  ,
  
	| output size = 448 bits  
	$1D134615 , $CE0B8376 , $92A35944 , $35D26466  ,
	$1DB7AEDE , $DD3C360C , $AF5D0BE3 , $5A3A3E91  ,
	$9F0C34CD , $F520D9D4 , $DDA48EC5 , $4D3AE612  ,
	$295698A4 , $9240153D , $D6389B78 , $C5CACDB0  ,
	$2FBBFD90 , $9F75A74A , $74DFABAC , $E79878CD  ,
	$741DB421 , $F4B2D818 , $A0534AD1 , $21DB4895  ,
	$06706D7D , $D4E49AE5 , $55CEA19F , $B2EEF72C  ,
	$603BDEBA , $F3E69889 , $A2F81607 , $A7ECFE58  ,
	$328401A7 , $34056125 , $275F0B5F , $73096110  ,
	$D1B17548 , $6285F95B , $C6847C12 , $B1B2CC4D  ,
	$E39A4C46 , $666CBA43 , $BF67FEDD , $6E6A920D  ,
  
	| output size = 480 bits  
	$E12D27A7 , $043FF4FC , $381D9D67 , $EE7CFD88  ,
	$FAFDD1F4 , $3FC132F0 , $56D23777 , $F1B02BFA  ,
	$0F36802A , $5D56CF5A , $326F7F77 , $15EC55C3  ,
	$2DBA88B8 , $8E28E38F , $8415932B , $34BC9908  ,
	$387AE120 , $38805CB7 , $ECBD45D3 , $09923083  ,
	$28077C3E , $CA2F47E3 , $98AA2869 , $55597017  ,
	$9706DC5C , $D84853FA , $64B3D086 , $2C175E1A  ,
	$42C658E1 , $1948A0AC , $EEDD9CAE , $FD90CE89  ,
	$CBE143C9 , $5755D779 , $6DC174EC , $BBBDC5FD  ,
	$D88C8760 , $C052A9D6 , $252D700E , $084A5959  ,
	$78DC3463 , $69C1402E , $EE5055CF , $5E909C8D  ,
  
	| output size = 512 bits  
	$20728DFD , $46C0BD53 , $E782B699 , $55304632  ,
	$71B4EF90 , $0EA9E82C , $DBB930F1 , $FAD06B8B  ,
	$BE0CAE40 , $8BD14410 , $76D2ADAC , $28ACAB7F  ,
	$C1099CB7 , $07B385F3 , $E7442C26 , $CC8AD640  ,
	$EB6F56C7 , $1EA81AA9 , $73B9D314 , $1DE85D08  ,
	$48910A5A , $893B22DB , $C5A0DF44 , $BBC4324E  ,
	$72D2F240 , $75941D99 , $6D8BDE82 , $A1A7502B  ,
	$D9BF68D1 , $58BAD750 , $56028CB2 , $8134F359  ,
	$B5D469D8 , $941A8CC2 , $418B2A6E , $04052780  ,
	$7F07D787 , $5194358F , $3C60D665 , $BE97D79A  ,
	$950C3434 , $AED9A06D , $2537DC8D , $7CDB5969  ,

256 constant #shabal-ctx 

: shabalinit ( outsize -- ctx )
	#shabal-ctx allocate 
	dup >r #shabal-ctx zero
	5 >> 1- 15 clamp 176 *
	shabal-iv + r@ 68 + 176 move
	r> ;

: shabal ( context a n -- )
	| n -> edx
	| a -> esi
	| context -> ebp
	asm{
		esi push
		edx eax mov
		# -4 [esi] ebp mov
		edx edx test
		5 L je
		# $40 [ebp] eax mov
		eax eax test
		3 L je
		1 [ebp]  [eax] *1  edi lea
		# $40 ecx mov
		eax ecx sub
		edx ecx cmp
		2 L jbe
	}

	asm{
		esi pop
	}
	3drop
	;
|||

1024 32 * constant SHABUF

: shabalfile ( a n -- a n )
	open/r >r
	SHABUF allocate 
	shabalinit
	repeat
		| buf
		dup SHABUF r@ read
		| buf n
		dup if
			over swap
			sha-update
			true
		else
			false
		then
	while
	| buf
	free
	r> close
	sha-final (sha1) ;

needs timer

: do1file ( n -- )
	argv 2dup
	shabalfile type space space type cr
	;
: dofiles argc 2 do i do1file loop ;

' dofiles timer-xt 
." Elapsed time: " .timer cr bye
